# Docker Compose Test Stack
# Complete integration testing environment for all agents
#Author: nguyễn Nhật Quang
#Created: 2025-11-24
services:
  # ==========================================================================
  # CORE DATA STORES
  # ==========================================================================
  
  # Neo4j - Property Graph Database
  neo4j:
    image: neo4j:5.12.0
    container_name: test-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/test12345
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_server_memory_heap_max__size=512M
      - NEO4J_server_memory_pagecache_size=256M
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    volumes:
      - neo4j_test_data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 60s  # Neo4j needs time to start and install APOC plugin
    networks:
      - test-network

  # Apache Jena Fuseki - Triplestore
  fuseki:
    image: stain/jena-fuseki:latest
    container_name: test-fuseki
    ports:
      - "3030:3030"
    environment:
      - ADMIN_PASSWORD=test_admin
      - JVM_ARGS=-Xmx512m -Xms256m
    volumes:
      - fuseki_test_data:/fuseki
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/$/ping"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s  # JVM needs time to start
    networks:
      - test-network

  # Redis - Cache and Message Broker
  redis:
    image: redis:7-alpine
    container_name: test-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass test_redis_pass --maxmemory 256mb --maxmemory-policy allkeys-lru --save "" --appendonly no
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # MongoDB - NGSI-LD Entity Storage
  mongodb:
    image: mongo:7.0
    container_name: test-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=mongodb_test_pass
      - MONGO_INITDB_DATABASE=ngsi_ld_entities
    volumes:
      - mongodb_test_data:/data/db
      - mongodb_test_config:/data/configdb
    command: --wiredTigerCacheSizeGB 0.5 --quiet
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - test-network

  # PostgreSQL - Stellio Backend (PostGIS for geometry support)
  postgres:
    image: timescale/timescaledb-ha:pg15  # TimescaleDB with PostGIS included
    container_name: test-postgres
    ports:
      - "5432:5432"  # Map PostgreSQL port for external access
    environment:
      - POSTGRES_USER=stellio
      - POSTGRES_PASSWORD=stellio_test
      - POSTGRES_DB=stellio_test
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./scripts/database/init-stellio-dbs-timescale.sql:/docker-entrypoint-initdb.d/init-stellio-dbs.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stellio -d stellio_search"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s  # Wait 60s before starting healthchecks (init script needs time)
    networks:
      - test-network

  # Kafka - Event Streaming (for Stellio)
  kafka:
    image: apache/kafka:latest
    container_name: test-kafka
    user: root
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    volumes:
      - kafka_test_data:/tmp/kraft-combined-logs
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9092 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 45s  # Kafka KRaft mode needs time to initialize
    networks:
      - test-network

  # ==========================================================================
  # STELLIO CONTEXT BROKER
  # ==========================================================================
  
  # Stellio API Gateway
  stellio-api-gateway:
    image: stellio/stellio-api-gateway:2.26.1  # Use stable release instead of latest
    container_name: test-stellio-api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres:5432/stellio_search  # Gateway needs search database!
      - SPRING_R2DBC_USERNAME=stellio
      - SPRING_R2DBC_PASSWORD=stellio_test
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - APPLICATION_AUTHENTICATION_ENABLED=false
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      search-service:
        condition: service_started
      subscription-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 12
      start_period: 60s  # Spring Boot app needs time to start
    networks:
      - test-network

  # Stellio Search Service (must be named 'search-service' for API Gateway routing)
  search-service:
    image: stellio/stellio-search-service:2.26.1  # Use stable release instead of latest
    container_name: test-stellio-search
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres:5432/stellio_search
      - SPRING_R2DBC_USERNAME=stellio
      - SPRING_R2DBC_PASSWORD=stellio_test
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      # Flyway baseline mode to handle PostGIS pre-populated table
      - SPRING_FLYWAY_BASELINE_ON_MIGRATE=true
      - SPRING_FLYWAY_BASELINE_VERSION=0.0  # Baseline BEFORE V0_1 to run all migrations
      - APPLICATION_AUTHENTICATION_ENABLED=false
      # Neo4j Configuration - Enable Graph Database Support
      - SPRING_NEO4J_URI=bolt://neo4j:7687
      - SPRING_NEO4J_AUTHENTICATION_USERNAME=neo4j
      - SPRING_NEO4J_AUTHENTICATION_PASSWORD=test12345
      - APPLICATION_NEO4J_ENABLED=true
      # Note: Gateway v2.26.1 routes to search-service:8083 (not entity-service:8082!)
    ports:
      - "8083:8083"  # Official Stellio port for search-service
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      test-network:
        aliases:
          - entity-service  # Gateway hardcoded to look for this hostname
          - search-service

  # Stellio Subscription Service (must be named 'subscription-service' for API Gateway routing)
  subscription-service:
    image: stellio/stellio-subscription-service:2.26.1  # Use stable release instead of latest
    container_name: test-stellio-subscription
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres:5432/stellio_subscription
      - SPRING_R2DBC_USERNAME=stellio
      - SPRING_R2DBC_PASSWORD=stellio_test
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      # Flyway baseline mode to handle PostGIS pre-populated table
      - SPRING_FLYWAY_BASELINE_ON_MIGRATE=true
      - SPRING_FLYWAY_BASELINE_VERSION=0.0  # Baseline BEFORE V0_1 to run all migrations
      - APPLICATION_AUTHENTICATION_ENABLED=false
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - test-network

  # ==========================================================================
  # PYTHON BACKEND (Citizen API + Orchestrator)
  # ==========================================================================
  
  python-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: python-backend
    command: python main.py --run-orchestrator-now
    restart: unless-stopped
    ports:
      - "8001:8001"
    depends_on:
      stellio-api-gateway:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      fuseki:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
      - STELLIO_URL=http://stellio-api-gateway:8080
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=test12345
      - FUSEKI_URL=http://fuseki:3030
      - FUSEKI_DATASET=traffic-cameras
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=test_redis_pass
      - MONGODB_URI=mongodb://admin:mongodb_test_pass@mongodb:27017
    volumes:
      - ./config:/app/config
      - ./data:/app/data
      - ./logs:/app/logs
      - ./assets:/app/assets
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - test-network

  # ==========================================================================
  # CV VERIFICATION SERVICE (Background Service)
  # ==========================================================================
  
  cv-verification-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cv-verification-service
    command: python start_cv_verification_service.py
    restart: unless-stopped
    depends_on:
      stellio-api-gateway:
        condition: service_healthy
    environment:
      - STELLIO_URL=http://stellio-api-gateway:8080
      - LOG_LEVEL=INFO
      - PYTHONPATH=/app
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      - ./assets:/app/assets  # YOLOv8 models
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import os; exit(0 if os.path.exists('/app/logs/cv_verification_service.log') else 1)\" || curl -sf http://stellio-api-gateway:8080/ngsi-ld/v1/entityTypes > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - test-network

  # ==========================================================================
  # WEB APPLICATION - BACKEND & FRONTEND
  # ==========================================================================
  
  # Backend API Server (TypeScript/Express)
  backend:
    build:
      context: ./apps/traffic-web-app/backend
      dockerfile: Dockerfile
    container_name: traffic-backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - STELLIO_URL=http://stellio-api-gateway:8080
      - NEO4J_URL=bolt://neo4j:7687
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=test12345
      - FUSEKI_URL=http://fuseki:3030
      - FUSEKI_DATASET=traffic-cameras
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=test_redis_pass
      - MONGODB_URI=mongodb://admin:mongodb_test_pass@mongodb:27017
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=stellio
      - POSTGRES_PASSWORD=stellio_test
      - POSTGRES_DB=stellio_search
    depends_on:
      stellio-api-gateway:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      fuseki:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    volumes:
      - ./apps/traffic-web-app/backend/logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - test-network
    restart: unless-stopped

  # Frontend Web Application (React/Vite)
  frontend:
    build:
      context: ./apps/traffic-web-app/frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://localhost:3001
        - VITE_WS_URL=ws://localhost:3001
    container_name: traffic-frontend
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - test-network
    restart: unless-stopped

  # ==========================================================================
  # TEST RUNNER
  # ==========================================================================
  
  test-runner:
    build:
      context: .
      dockerfile: docker/Dockerfile.test.optimized
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: test-runner
    command: pytest tests/integration/test_complete_system.py -v --cov=agents --cov-report=html --cov-report=term-missing --cov-report=xml --tb=short
    depends_on:
      stellio-api-gateway:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      fuseki:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Service URLs
      - STELLIO_URL=http://stellio-api-gateway:8080
      - NEO4J_URL=bolt://neo4j:7687
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=test12345
      - FUSEKI_URL=http://fuseki:3030
      - FUSEKI_DATASET=traffic-cameras
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=test_redis_pass
      
      # Test configuration
      - TEST_DATA_DIR=/app/test_data
      - TEST_OUTPUT_DIR=/app/test_output
      - TEST_TIMEOUT=300
      - COVERAGE_THRESHOLD=90
      
      # Logging
      - LOG_LEVEL=INFO
      - PYTEST_VERBOSE=1
    volumes:
      - ./agents:/app/agents
      - ./tests:/app/tests
      - ./config:/app/config
      - ./test_data:/app/test_data
      - ./test_output:/app/test_output
      - ./htmlcov:/app/htmlcov
      - ./coverage.xml:/app/coverage.xml
    networks:
      - test-network

# ==========================================================================
# NETWORKS AND VOLUMES
# ==========================================================================

networks:
  test-network:
    driver: bridge

volumes:
  neo4j_test_data:
    driver: local
  fuseki_test_data:
    driver: local
  redis_test_data:
    driver: local
  mongodb_test_data:
    driver: local
  mongodb_test_config:
    driver: local
  postgres_test_data:
    driver: local
  kafka_test_data:
    driver: local
