# Traffic Web Application

**Integrated from**: Layer-Business  
**Status**: Production Ready âœ…  
**Version**: 1.0.0

---

## ğŸ“‹ Overview

Full-stack traffic monitoring web application vá»›i real-time data visualization, AI-powered agents, vÃ  comprehensive analytics dashboard. Application nÃ y query data tá»« shared infrastructure (Stellio, Neo4j, Fuseki, PostgreSQL) Ä‘Æ°á»£c generate bá»Ÿi Python orchestrator.

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Traffic Web Application                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Frontend (React + TypeScript)                      â”‚
â”‚  â”œâ”€â”€ Dashboard with Leaflet Map                     â”‚
â”‚  â”œâ”€â”€ Real-time WebSocket Updates                    â”‚
â”‚  â”œâ”€â”€ Analytics Dashboard (Recharts)                 â”‚
â”‚  â”œâ”€â”€ 3 AI Agent Chat Interfaces                     â”‚
â”‚  â””â”€â”€ Responsive UI (Tailwind CSS)                   â”‚
â”‚                                                      â”‚
â”‚  Backend (Node.js + Express + TypeScript)           â”‚
â”‚  â”œâ”€â”€ REST API (12 route groups)                     â”‚
â”‚  â”œâ”€â”€ WebSocket Server (real-time broadcasting)      â”‚
â”‚  â”œâ”€â”€ 3 AI Agents (GraphRAG, EcoTwin, TrafficMaestro)â”‚
â”‚  â””â”€â”€ Data Services (Stellio, Neo4j, Fuseki, Postgres)â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Query Data From â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Shared Infrastructure                      â”‚
â”‚  â”œâ”€â”€ Stellio (NGSI-LD entities)                     â”‚
â”‚  â”œâ”€â”€ Neo4j (accident graph)                         â”‚
â”‚  â”œâ”€â”€ Fuseki (RDF triples)                           â”‚
â”‚  â””â”€â”€ PostgreSQL (metrics & predictions)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ Generated By â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Python Orchestrator (Builder-Layer-End)      â”‚
â”‚  â”œâ”€â”€ YOLOX Computer Vision                          â”‚
â”‚  â”œâ”€â”€ DETR Accident Detection                        â”‚
â”‚  â”œâ”€â”€ LOD Enrichment                                 â”‚
â”‚  â””â”€â”€ NGSI-LD Publishing                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Quick Start

### Prerequisites

- **Node.js 18+** and npm
- **Running Docker containers**: Stellio, Neo4j, Fuseki, PostgreSQL
- **Python orchestrator** (optional, for data generation)

### Installation

```bash
# Navigate to web app directory
cd apps/traffic-web-app

# Install all dependencies (backend + frontend)
npm run install:all

# Or install separately
cd backend && npm install
cd frontend && npm install
```

### Configuration

**Backend** (`backend/.env`):
```env
# Server
PORT=5001
NODE_ENV=development

# Shared Infrastructure
STELLIO_URL=http://localhost:8080
FUSEKI_URL=http://localhost:3030
FUSEKI_USER=admin
FUSEKI_PASSWORD=test_admin
NEO4J_URL=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=test12345
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=stellio_user
POSTGRES_PASSWORD=stellio_test
POSTGRES_DB=stellio_search

# AI Agents (Optional)
GEMINI_API_KEY=your_gemini_api_key
OPENAI_API_KEY=your_openai_api_key
TICKETMASTER_API_KEY=your_ticketmaster_key
MAPBOX_API_KEY=your_mapbox_key
```

**Frontend** (`frontend/.env`):
```env
VITE_API_URL=http://localhost:5001
VITE_WS_URL=ws://localhost:5001
```

### Development

**Option 1: Start both (recommended)**
```bash
cd apps/traffic-web-app
npm run dev
# Backend: http://localhost:5001
# Frontend: http://localhost:3000 (or 5173)
```

**Option 2: Start separately**
```bash
# Terminal 1: Backend
cd apps/traffic-web-app/backend
npm run dev

# Terminal 2: Frontend
cd apps/traffic-web-app/frontend
npm run dev
```

### Production Build

```bash
# Build both
cd apps/traffic-web-app
npm run build:all

# Start production servers
npm run start:backend  # Backend on port 5001
npm run start:frontend # Frontend preview
```

## ğŸ“¡ Backend API

### Core Entity Endpoints

- `GET /api/cameras` - Traffic cameras
- `GET /api/weather` - Weather observations
- `GET /api/air-quality` - Air quality measurements
- `GET /api/accidents` - Road accidents
- `GET /api/patterns` - Traffic patterns

### Analytics Endpoints

- `GET /api/analytics/congestion` - Congestion analysis
- `GET /api/analytics/hotspots` - Accident hotspots
- `GET /api/analytics/correlations` - Multi-factor correlations
- `GET /api/historical` - Historical data playback

### AI Agent Endpoints

**GraphInvestigatorAgent** (Multimodal Incident Analysis)
- `POST /api/agents/graph-investigator/investigate` - Investigate accident with full context
- `POST /api/agents/graph-investigator/vision-analysis` - Computer vision hazard detection

**EcoTwinAgent** (Environmental Health Advisor)
- `POST /api/agents/eco-twin/chat` - Personalized health advice
- `POST /api/agents/eco-twin/dispersion` - AQI prediction simulation
- `POST /api/agents/eco-twin/forecast` - Environmental forecast

**TrafficMaestroAgent** (Predictive Event Orchestrator)
- `GET /api/agents/traffic-maestro/events` - External events monitoring
- `POST /api/agents/traffic-maestro/predict-congestion` - Event-based congestion prediction
- `POST /api/agents/traffic-maestro/benchmark-routes` - Route optimization

### Health & Status

- `GET /health` - Server health with connection status
- `GET /api/agents/*/health` - Individual agent health checks

**Full API Documentation**: See `docs/API.md`

## ğŸ¨ Frontend Features

### Dashboard Components

1. **TrafficMap** - Interactive Leaflet map vá»›i 8 overlays:
   - Camera markers
   - Pollutant circles (AQI visualization)
   - Humidity/Visibility layer
   - Vehicle heatmap
   - Speed zones
   - Correlation lines
   - Pattern zones
   - Accident frequency chart

2. **AnalyticsDashboard** - Real-time charts:
   - Traffic volume trends
   - Air quality timeline
   - Weather correlation
   - Congestion heatmap

3. **Sidebar** - Filters & Statistics:
   - Layer toggles
   - Date range picker
   - Entity count summaries
   - Connection status indicator

4. **AI Agent Chat Interfaces**:
   - **Health Advisor** (EcoTwinAgent) - Environmental health recommendations
   - **Investigator** (GraphInvestigatorAgent) - Accident root cause analysis
   - **Predictive Timeline** (TrafficMaestroAgent) - Event-based traffic predictions

### Real-time Features

- **WebSocket Updates**: Live data streaming every 30 seconds
- **Change Detection**: Only broadcast changed entities (bandwidth optimization)
- **Notification System**: Custom toast notifications vá»›i sound alerts
- **Auto-reconnect**: Exponential backoff for WebSocket failures

## ğŸ¤– AI Agents

### 1. GraphInvestigatorAgent

**Purpose**: Multimodal incident analysis combining internal LOD data, computer vision, and external intelligence.

**Capabilities**:
- Query Neo4j graph for accident relationships
- Computer vision analysis (Google Gemini Flash) for visual hazards
- External news/social media search (Tavily API)
- Root cause determination with confidence scoring
- Automated response team recommendations

**Use Case**: When accident detected, investigate vá»›i full context Ä‘á»ƒ xÃ¡c Ä‘á»‹nh:
- Root cause (technical vs environmental vs human error)
- Severity assessment (visual + data-driven)
- Required response teams (fire, police, cleanup, medical)
- Estimated response time

### 2. EcoTwinAgent

**Purpose**: Environmental health advisor with air quality dispersion simulation.

**Capabilities**:
- Simulate AQI dispersion based on weather forecasts
- Personalized health advice (AI-generated via Gemini Pro)
- Risk level assessment for vulnerable populations
- Best time window recommendations for outdoor activities
- Publish forecasts to Stellio for visualization

**Use Case**: User asks "HÃ´m nay cÃ³ nÃªn Ä‘i xe mÃ¡y khÃ´ng?" â†’ Agent provides:
- Current AQI + predicted AQI in next 6 hours
- Health risk assessment based on user profile
- Recommendations (wear mask, avoid peak hours, use car instead)
- Best departure time windows

### 3. TrafficMaestroAgent

**Purpose**: Predictive event orchestrator correlating traffic patterns vá»›i external events.

**Capabilities**:
- Monitor external events (Ticketmaster, Google Calendar)
- Predict congestion based on event characteristics
- Route benchmarking (Mapbox API vs internal patterns)
- Generate preemptive action plans (green wave, detours)
- Surge risk scoring (0-100 scale)

**Use Case**: Concert at Saigon Opera House (5000 attendees) â†’ Agent:
- Identifies affected cameras within 2km radius
- Calculates surge risk score (e.g., 78/100 - High Risk)
- Recommends action plan (green wave on main routes, detour alerts)
- Compares Mapbox routes vs internal predictions

## ğŸ“ Project Structure

```
apps/traffic-web-app/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ server.ts              # Main Express server
â”‚   â”‚   â”œâ”€â”€ agents/                # 3 AI agents
â”‚   â”‚   â”‚   â”œâ”€â”€ GraphInvestigatorAgent.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ EcoTwinAgent.ts
â”‚   â”‚   â”‚   â””â”€â”€ TrafficMaestroAgent.ts
â”‚   â”‚   â”œâ”€â”€ services/              # Data source clients
â”‚   â”‚   â”‚   â”œâ”€â”€ stellioService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ fusekiService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ neo4jService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ postgresService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ websocketService.ts
â”‚   â”‚   â”‚   â””â”€â”€ dataAggregator.ts
â”‚   â”‚   â”œâ”€â”€ routes/                # REST API routes
â”‚   â”‚   â”‚   â”œâ”€â”€ cameraRoutes.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ accidentRoutes.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ agentRoutes.ts
â”‚   â”‚   â”‚   â””â”€â”€ ... (12 files)
â”‚   â”‚   â”œâ”€â”€ utils/                 # Utilities
â”‚   â”‚   â”œâ”€â”€ types/                 # TypeScript types
â”‚   â”‚   â”œâ”€â”€ config/                # Config loader
â”‚   â”‚   â””â”€â”€ middlewares/           # Error handling
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ entities.yaml          # NGSI-LD entity mappings
â”‚   â”‚   â””â”€â”€ agents/                # AI agent configs
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ .env
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx                # Root component
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ Dashboard.tsx      # Main dashboard
â”‚   â”‚   â”‚   â””â”€â”€ LandingPage.tsx    # Landing page
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ TrafficMap.tsx     # Leaflet map
â”‚   â”‚   â”‚   â”œâ”€â”€ AnalyticsDashboard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â”‚   â”‚   â””â”€â”€ agents/            # AI agent UIs
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts             # Axios client
â”‚   â”‚   â”‚   â””â”€â”€ websocket.ts       # WebSocket client
â”‚   â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â”‚   â””â”€â”€ trafficStore.ts    # Zustand store
â”‚   â”‚   â””â”€â”€ types/
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”œâ”€â”€ tailwind.config.js
â”‚   â””â”€â”€ .env
â”‚
â”œâ”€â”€ docs/                          # Documentation
â”‚   â”œâ”€â”€ API.md
â”‚   â”œâ”€â”€ AGENT_TESTING_REPORT.md
â”‚   â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md
â”‚   â””â”€â”€ ... (30+ files)
â”‚
â”œâ”€â”€ package.json                   # Root package.json
â”œâ”€â”€ start-dev.ps1                  # Dev launcher script
â””â”€â”€ README.md                      # This file
```

## ğŸ”§ Configuration Files

### Backend Config (`backend/config/entities.yaml`)

Domain-agnostic NGSI-LD entity definitions vá»›i automatic field mapping:

```yaml
entities:
  Camera:
    entityType: "Camera"
    endpoint: "/api/cameras"
    fields:
      id: { ngsiPath: "id", type: "string", required: true }
      location: { ngsiPath: "location.value.coordinates", type: "geopoint", transform: "coordinatesToLatLng" }
      status: { ngsiPath: "status.value", type: "string", enum: ["active", "inactive"] }
    filters:
      - name: "status"
        field: "status"
        operator: "equals"
```

### AI Agent Configs (`backend/config/agents/`)

**graph-investigator.yaml**: Vision, search, and synthesis settings  
**eco-twin.yaml**: AQI simulation, weather provider, AI model  
**traffic-maestro.yaml**: Event sources, routing provider, prediction rules

## ğŸ§ª Testing

### Backend Tests

```bash
cd backend

# Test all connections
npm run test:connections

# Test specific endpoints
npm run test:camera
npm run test:weather
npm run test:airquality

# Test all endpoints
npm run test:all

# Test AI agents (requires API keys)
npm run test:agents
```

### Frontend Development

```bash
cd frontend

# Start dev server
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview
```

## ğŸ“Š Performance Considerations

### Backend Optimizations

- **Connection Pooling**: 50 max sockets for Stellio, 10 for Neo4j
- **Retry Logic**: 3 attempts vá»›i exponential backoff
- **Caching**: 30-second cache cho GET requests
- **Change Detection**: Only broadcast changed entities (90% bandwidth reduction)
- **API Key Rotation**: Automatic rotation when rate limit hit

### Frontend Optimizations

- **Code Splitting**: Route-based lazy loading
- **Memoization**: React.memo for expensive components
- **Debouncing**: Map interactions, filter changes
- **Virtual Scrolling**: Large lists (accidents, cameras)
- **WebSocket Optimization**: Heartbeat ping/pong, auto-reconnect

## ğŸš¢ Deployment

### Docker Deployment (Recommended)

See root `docker-compose.yml` for full stack deployment:

```bash
# From Builder-Layer-End root
docker-compose up traffic-api traffic-ui
```

### Manual Deployment

**Backend**:
```bash
cd backend
npm run build
npm start  # Production server on port 5001
```

**Frontend**:
```bash
cd frontend
npm run build
# Serve dist/ with nginx or serve
npx serve -s dist -p 3000
```

## ğŸ”— Integration with Python Orchestrator

### Data Flow

```
Python Orchestrator â†’ Stellio/Neo4j/Fuseki/Postgres
                              â†“
                    Node.js Backend (Query Data)
                              â†“
                    React Frontend (Display)
```

### Shared Credentials

Both Python and Node.js use same `.env` configuration (root level).

### Independent Operation

- **Python alone**: Data generation without web UI
- **Node.js alone**: Query existing data without new generation
- **Together**: Full stack real-time monitoring

## ğŸ“š Documentation

### Full Documentation

- **API Reference**: `docs/API.md` (465 lines)
- **Agent Testing**: `docs/AGENT_TESTING_REPORT.md` (411 lines)
- **Implementation Guide**: `docs/IMPLEMENTATION_SUMMARY.md` (563 lines)
- **Data Access**: `../../Layer-Business/.a/DATA_ACCESS_GUIDE.md` (7204 lines)

### Quick References

- **Backend Quickstart**: `backend/README.md`
- **Frontend Quickstart**: `frontend/README.md`
- **Agent Usage Examples**: `backend/examples/`

## â“ Troubleshooting

### Backend Won't Start

```bash
# Check Docker containers
docker ps

# Verify Stellio accessible
curl http://localhost:8080/ngsi-ld/v1/entities?type=Camera

# Check Neo4j
cypher-shell -u neo4j -p test12345 -a bolt://localhost:7687
```

### Frontend Can't Connect

```bash
# Verify backend running
curl http://localhost:5001/health

# Check WebSocket
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" http://localhost:5001
```

### No Data Showing

```bash
# Verify Python orchestrator ran
ls -l ../../data/accidents.json

# Check Stellio entities
curl "http://localhost:8080/ngsi-ld/v1/entities?type=Camera&limit=5"

# Seed accidents if empty
cd ../..
python seed_accidents_to_databases.py
```

## ğŸ¯ Next Steps

1. **Start infrastructure**: `docker-compose up -d` (from root)
2. **Run Python orchestrator**: `python main.py` (generate data)
3. **Start web app**: `npm run dev` (from this directory)
4. **Access dashboard**: http://localhost:3000

## ğŸ“ License

MIT License - See root LICENSE file

## ğŸ‘¥ Contributors

Integrated from Layer-Business project - Full-stack traffic monitoring application.

---

**Parent Project**: Builder-Layer-End  
**Integration Date**: November 27, 2025  
**Status**: Production Ready âœ…
