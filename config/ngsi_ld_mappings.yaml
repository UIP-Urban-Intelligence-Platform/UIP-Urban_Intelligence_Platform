# ============================================================================
# UIP - Urban Intelligence Platform
# Copyright (c) 2025 UIP Team. All rights reserved.
# https://github.com/UIP-Urban-Intelligence-Platform/UIP-Urban_Intelligence_Platform
#
# SPDX-License-Identifier: MIT
# ============================================================================
# File: config/ngsi_ld_mappings.yaml
# Module: NGSI-LD Entity Mapper Configuration
# Author: Nguyen Dinh Anh Tuan
# Created: 2025-11-22
# Version: 1.0.0
# License: MIT
#
# Description:
#   Domain-agnostic transformation rules for converting raw data to NGSI-LD
#   Works with ANY LOD domain by changing these mappings
# ============================================================================

# Entity Type Configuration
entity_type: "Camera"
uri_prefix: "urn:ngsi-ld:Camera:"
id_field: "code"

# Property Mappings: source_field → NGSI-LD property name
property_mappings:
  name:
    target: "cameraName"
    type: "Property"

  code:
    target: "cameraNum"
    type: "Property"

  ptz:
    target: "cameraType"
    type: "Property"
    transform: "boolean_to_ptz" # True→PTZ, False→Fixed

  cam_type:
    target: "cameraUsage"
    type: "Property"
    transform: "uppercase" # tth→TRAFFIC

  url:
    target: "streamUrl"
    type: "Property"

  image:
    target: "imageUrl"
    type: "Property"

  image_url_x4:
    target: "imageSnapshot"
    type: "Property"
    description: "High resolution camera snapshot URL"

  address:
    target: "address"
    type: "Property"
    description: "Street address or intersection location"

  description:
    target: "description"
    type: "Property"

  status:
    target: "status"
    type: "Property"

  updated_at:
    target: "dateLastValueReported"
    type: "Property"
    transform: "iso_datetime"

  last_update:
    target: "dateModified"
    type: "Property"
    transform: "iso_datetime"

# GeoProperty Mapping (GeoJSON format)
geo_property:
  source: ["latitude", "longitude"]
  target: "location"
  format: "Point"
  type: "GeoProperty"

# Relationship Mappings for Camera entity
# Following NGSI-LD Smart Data Models standards
# These create bidirectional links with WeatherObserved and AirQualityObserved
# Reference: https://github.com/smart-data-models/dataModel.Device
relationships:
  # Link to WeatherObserved observation point
  # This relationship is dynamically created during transformation
  # when weather data exists for the camera
  - target: "refWeatherObserved"
    type: "Relationship"
    dynamic: true # Generated during transform, not from source field
    description: "Reference to the WeatherObserved entity associated with this Camera"

  # Link to AirQualityObserved observation point
  # This relationship is dynamically created during transformation
  # when air quality data exists for the camera
  - target: "refAirQualityObserved"
    type: "Relationship"
    dynamic: true # Generated during transform, not from source field
    description: "Reference to the AirQualityObserved entity associated with this Camera"

# NGSI-LD Context URLs
context_urls:
  - "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
  - "https://raw.githubusercontent.com/smart-data-models/dataModel.Device/master/context.jsonld"

# Transformation Functions
transforms:
  boolean_to_ptz:
    type: "boolean_map"
    true_value: "PTZ"
    false_value: "Fixed"

  uppercase:
    type: "string_uppercase"

  iso_datetime:
    type: "datetime_format"
    output_format: "iso8601"

# Validation Rules
validation:
  required_fields:
    - "id"
    - "type"
    - "@context"

  required_properties:
    - "location"

  geo_constraints:
    latitude_range: [-90, 90]
    longitude_range: [-180, 180]

# Processing Options
processing:
  batch_size: 100
  source_file: "data/cameras_enriched.json" # UPDATED: Read from enriched file
  output_file: "data/ngsi_ld_entities.json"
  validate_output: true
  pretty_print: true

# ==============================================================================
# WEATHER OBSERVED MAPPINGS (NEW)
# ==============================================================================
weather_mappings:
  entity_type: "WeatherObserved"
  uri_prefix: "urn:ngsi-ld:WeatherObserved:"
  ref_device_prefix: "urn:ngsi-ld:Camera:"
  source_field: "weather" # Extract data from "weather" key in enriched entity

  property_mappings:
    temperature:
      target: "temperature"
      type: "Property"
      unit: "CEL"

    humidity:
      target: "relativeHumidity"
      type: "Property"
      unit: "P1"

    wind_speed:
      target: "windSpeed"
      type: "Property"
      unit: "MTS"

    rain_1h:
      target: "precipitation"
      type: "Property"
      unit: "MMT"
      default: 0.0

    description:
      target: "weatherType"
      type: "Property"

    pressure:
      target: "atmosphericPressure"
      type: "Property"
      unit: "A97"

    clouds:
      target: "cloudiness"
      type: "Property"
      unit: "P1"

  # Weather observations use same location as camera
  geo_property:
    source: ["latitude", "longitude"]
    target: "location"
    format: "Point"
    type: "GeoProperty"

  context_urls:
    - "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
    - "https://smart-data-models.github.io/dataModel.Weather/context.jsonld"

# ==============================================================================
# AIR QUALITY OBSERVED MAPPINGS (NEW)
# ==============================================================================
airquality_mappings:
  entity_type: "AirQualityObserved"
  uri_prefix: "urn:ngsi-ld:AirQualityObserved:"
  ref_device_prefix: "urn:ngsi-ld:Camera:"
  source_field: "air_quality" # Extract data from "air_quality" key in enriched entity

  property_mappings:
    aqi:
      target: "airQualityIndex"
      type: "Property"

    pm25:
      target: "pm25"
      type: "Property"
      unit: "GQ"

    pm10:
      target: "pm10"
      type: "Property"
      unit: "GQ"

    co:
      target: "co"
      type: "Property"
      unit: "GP"

    o3:
      target: "o3"
      type: "Property"
      unit: "GQ"

    no2:
      target: "no2"
      type: "Property"
      unit: "GQ"

    so2:
      target: "so2"
      type: "Property"
      unit: "GQ"

    nh3:
      target: "nh3"
      type: "Property"
      unit: "GQ"
      description: "Ammonia concentration (bonus pollutant from OpenWeatherMap)"

    aqi_category:
      target: "airQualityCategory"
      type: "Property"
      description: "Air quality category (Good/Fair/Moderate/Poor/Very Poor)"

    aqi_index:
      target: "airQualityIndexValue"
      type: "Property"
      description: "Numeric AQI value from OpenWeatherMap (1-5)"

    source:
      target: "dataProvider"
      type: "Property"
      description: "Data source provider (OpenWeatherMap)"

    location_name:
      target: "stationName"
      type: "Property"

    distance_km:
      target: "distanceFromDevice"
      type: "Property"
      unit: "KMT"

  # Air quality observations use same location as camera
  geo_property:
    source: ["latitude", "longitude"]
    target: "location"
    format: "Point"
    type: "GeoProperty"

  context_urls:
    - "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
    - "https://smart-data-models.github.io/dataModel.Environment/context.jsonld"
# Example: Healthcare domain mapping (commented - activate when needed)
# entity_type: "MedicalDevice"
# uri_prefix: "urn:ngsi-ld:MedicalDevice:"
# id_field: "device_id"
# property_mappings:
#   device_name:
#     target: "deviceName"
#     type: "Property"
#   status:
#     target: "operationalStatus"
#     type: "Property"
#     transform: "uppercase"

# Example: Commerce domain mapping (commented - activate when needed)
# entity_type: "Store"
# uri_prefix: "urn:ngsi-ld:Store:"
# id_field: "store_code"
# property_mappings:
#   store_name:
#     target: "storeName"
#     type: "Property"
#   opening_hours:
#     target: "openingHours"
#     type: "Property"
