# ============================================================================
# UIP - Urban Intelligence Platform
# Copyright (c) 2025 UIP Team. All rights reserved.
# https://github.com/UIP-Urban-Intelligence-Platform/UIP-Urban_Intelligence_Platform
#
# SPDX-License-Identifier: MIT
# ============================================================================
# File: docker/Dockerfile.test.optimized
# Module: Optimized Multi-Stage Dockerfile for Integration Testing
# Author: Nguyen Nhat Quang
# Created: 2025-11-24
# Version: 1.0.0
# License: MIT
#
# Description:
#   Reduces final image size by 60-70%
# ============================================================================

# Stage 1: Builder - Install dependencies
FROM python:3.10-slim AS builder

WORKDIR /build

# Install only build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Create virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install Python packages in virtual environment
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir \
    pytest==7.4.3 \
    pytest-asyncio==0.21.1 \
    pytest-cov==4.1.0 \
    pytest-mock==3.12.0 \
    pytest-timeout==2.2.0 \
    httpx==0.26.0 \
    aiohttp==3.9.1 \
    PyYAML==6.0.1 \
    neo4j==5.14.0 \
    redis==5.0.1 \
    rdflib==7.0.0

# Stage 2: Runtime - Minimal image
FROM python:3.10-slim

WORKDIR /app

# Install only runtime dependencies (curl for healthchecks)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && apt-get autoremove -y

# Copy virtual environment from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy only necessary application files
COPY agents/ agents/
COPY config/ config/
COPY tests/integration/ tests/integration/

# Create minimal directories
RUN mkdir -p test_output htmlcov

# Optimize Python runtime
ENV PYTHONPATH=/app \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONHASHSEED=random

# Run as non-root user for security
RUN useradd -m -u 1000 testuser && \
    chown -R testuser:testuser /app
USER testuser

# Default command
CMD ["pytest", "tests/integration/", "-v", "--tb=short"]
