# Integration Tests CI/CD Workflow
# Automated testing pipeline for complete system integration
#Author: nguyễn Nhật Quang
#Created: 2025-11-21
name: Integration Tests

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger

env:
  PYTHON_VERSION: '3.10'
  DOCKER_COMPOSE_VERSION: '2.23.0'
  COVERAGE_THRESHOLD: 90

jobs:
  # ==========================================================================
  # LINT AND TYPE CHECK
  # ==========================================================================
  
  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 mypy black isort pylint
          pip install -r requirements/base.txt -r requirements/dev.txt
      
      - name: Run Black (code formatting check)
        run: black --check src/ tests/
      
      - name: Run isort (import sorting check)
        run: isort --check-only src/ tests/
      
      - name: Run flake8 (linting)
        run: flake8 src/ tests/ --max-line-length=100 --ignore=E203,W503
      
      - name: Run mypy (type checking)
        run: mypy src/ --ignore-missing-imports
      
      - name: Run pylint (code quality)
        run: pylint src/ --disable=C0111,R0903,W0212 --max-line-length=100

  # ==========================================================================
  # UNIT TESTS
  # ==========================================================================
  
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/base.txt -r requirements/test.txt
      
      - name: Run unit tests
        run: |
          pytest tests/unit/ \
            -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-unit

  # ==========================================================================
  # INTEGRATION TESTS
  # ==========================================================================
  
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Start Docker Compose stack
        run: |
          docker-compose up -d
          echo "Waiting for services to be healthy..."
          sleep 60
      
      - name: Check service health
        run: |
          docker-compose ps
          
          # Check Stellio
          curl -f http://localhost:8080/actuator/health || exit 1
          
          # Check Fuseki
          curl -f http://localhost:3030/$/ping || exit 1
          
          # Check Neo4j
          docker-compose exec -T neo4j cypher-shell -u neo4j -p test12345 "RETURN 1" || exit 1
          
          echo "All services are healthy"
      
      - name: Run integration tests
        run: |
          docker-compose run --rm test-runner \
            pytest tests/integration/test_complete_system.py \
            -v \
            --cov=agents \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --duration=10 \
            --tb=short \
            -m "integration"
      
      - name: Copy coverage reports
        if: always()
        run: |
          docker cp test-runner:/app/coverage.xml ./coverage.xml
          docker cp test-runner:/app/htmlcov ./htmlcov
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: integration
          name: codecov-integration
      
      - name: Upload HTML coverage report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: htmlcov/
      
      - name: Print Docker logs on failure
        if: failure()
        run: |
          docker-compose logs stellio-api-gateway
          docker-compose logs neo4j
          docker-compose logs fuseki
          docker-compose logs redis
      
      - name: Cleanup Docker stack
        if: always()
        run: |
          docker-compose down -v

  # ==========================================================================
  # PERFORMANCE TESTS
  # ==========================================================================
  
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Start Docker Compose stack
        run: |
          docker-compose up -d
          echo "Waiting for services..."
          sleep 60
      
      - name: Run performance benchmarks
        run: |
          docker-compose run --rm test-runner \
            pytest tests/integration/ \
            -v \
            -m "performance" \
            --duration=10 \
            --tb=short
      
      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # ==========================================================================
  # E2E TESTS (Full 722-camera pipeline)
  # ==========================================================================
  
  e2e-tests:
    name: End-to-End Tests (722 Cameras)
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 45
    if: github.event_name == 'push' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Start Docker Compose stack
        run: |
          docker-compose up -d
          echo "Waiting for services..."
          sleep 90
      
      - name: Generate test data
        run: |
          docker-compose run --rm app \
            python -m pytest tests/integration/ --collect-only
      
      - name: Run E2E pipeline test
        run: |
          docker-compose run --rm app \
            pytest tests/integration/ \
            -v \
            --tb=short \
            --duration=10
      
      - name: Generate test report
        if: always()
        run: |
          docker-compose run --rm app \
            pytest tests/integration/ \
            --html=report.html \
            --self-contained-html
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-report
          path: report.html
      
      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # ==========================================================================
  # SECURITY SCAN
  # ==========================================================================
  
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
      
      - name: Run Safety (dependency vulnerability scan)
        run: safety check --json || true
      
      - name: Run Bandit (security issues scan)
        run: bandit -r src/ -f json -o bandit-report.json
      
      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: bandit-report.json

  # ==========================================================================
  # BUILD DOCKER IMAGES
  # ==========================================================================
  
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        if: github.event_name == 'push'
        continue-on-error: true
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push image
        if: github.event_name == 'push'
        continue-on-error: true
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile.test
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/builder-layer-test:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/builder-layer-test:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
  # ==========================================================================
  # DEPLOY DOCUMENTATION
  # ==========================================================================
  
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install sphinx sphinx-rtd-theme
      
      - name: Build documentation
        run: |
          cd docs
          echo "Documentation build skipped - no sphinx config yet"
      
      - name: Deploy to GitHub Pages
        if: false
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html

  # ==========================================================================
  # NOTIFICATION
  # ==========================================================================
  
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, performance-tests, security-scan]
    if: always()
    
    steps:
      - name: Send Slack notification
        if: failure()
        continue-on-error: true
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "❌ Integration Tests Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Integration Tests Failed*\n\nWorkflow: ${{ github.workflow }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Integration tests failed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
