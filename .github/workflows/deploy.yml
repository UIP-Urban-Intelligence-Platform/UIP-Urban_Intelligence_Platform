# ============================================================================
# UIP - Urban Intelligence Platform
# Copyright (c) 2024-2025 UIP Team. All rights reserved.
# https://github.com/UIP-Urban-Intelligence-Platform/UIP-Urban_Intelligence_Platform
#
# SPDX-License-Identifier: MIT
# ============================================================================
# File: .github/workflows/deploy.yml
# Module: CI/CD Pipeline - Auto Deploy to Ubuntu VPS
# Author: Nguyen Dinh Anh Tuan
# Created: 2025-12-08
# Version: 1.0.0
# License: MIT
#
# Description:
#   Automated CI/CD pipeline for deploying to Ubuntu VPS
#   - Ch·ª©c nƒÉng 1: T·ª± ƒë·ªông ƒë·∫©y code l√™n server khi c√≥ thay ƒë·ªïi tr√™n GitHub
#   - Ch·ª©c nƒÉng 2: T·ª± ƒë·ªông kh·ªüi ch·∫°y l·∫°i project sau khi deploy
#
# Server Info:
#   - IP:
#   - User:
#   - Path: /home/deepminds/builder-layer-end
#
# Prerequisites:
#   1. T·∫°o c√°c secrets trong GitHub Repository Settings > Secrets:
#      - VPS_HOST:
#      - VPS_USER:
#      - VPS_SSH_KEY: Private SSH key ƒë·ªÉ k·∫øt n·ªëi VPS
#      - VPS_PORT: 22
#      - VPS_PASSWORD: Password SSH (n·∫øu d√πng password thay v√¨ key)
#
#   2. Tr√™n VPS Ubuntu ƒë√£ c√≥ s·∫µn:
#      - Python 3.x
#      - Node.js
#      - Docker & Docker Compose
#
# Usage:
#   - Push code l√™n branch main s·∫Ω t·ª± ƒë·ªông trigger deploy
#   - C√≥ th·ªÉ ch·∫°y th·ªß c√¥ng t·ª´ Actions tab
# ============================================================================

name: Deploy to Ubuntu VPS

on:
  # Trigger khi push l√™n branch main ho·∫∑c tuan
  push:
    branches:
      - main
      - tuan

  # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ GitHub Actions tab
  workflow_dispatch:
    inputs:
      skip_orchestrator:
        description: "Skip running orchestrator and CV sync"
        required: false
        default: false
        type: boolean
      full_restart:
        description: "Full restart (stop all services first)"
        required: false
        default: false
        type: boolean

env:
  PROJECT_NAME: uip-urban-intelligence-platform

jobs:
  # ===========================================================================
  # Job 1: Deploy code to VPS
  # ===========================================================================
  deploy:
    name: üöÄ Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      # B∆∞·ªõc 1: Checkout code
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for proper sync

      # B∆∞·ªõc 2: Install sshpass (ƒë·ªÉ d√πng password SSH)
      - name: üîß Install sshpass
        run: sudo apt-get install -y sshpass

      # B∆∞·ªõc 3: Deploy code l√™n VPS b·∫±ng rsync
      - name: üì§ Deploy code to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          echo "üöÄ Deploying to VPS: $VPS_HOST"

          # Disable strict host key checking
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

          # Sync code using rsync v·ªõi sshpass (password authentication)
          sshpass -p "$VPS_PASSWORD" rsync -avz --delete \
            --exclude '.git' \
            --exclude '.venv' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'logs/*' \
            --exclude 'data/cache/*' \
            --exclude 'test_output/*' \
            --exclude 'htmlcov' \
            --exclude 'coverage.xml' \
            --exclude '.pytest_cache' \
            --exclude 'assets/models/*.pth' \
            -e "ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no" \
            ./ ${VPS_USER}@${VPS_HOST}:/home/${VPS_USER}/builder-layer-end/

          echo "‚úÖ Code deployed successfully!"

      # B∆∞·ªõc 4: Setup Environment Files
      - name: üìÑ Setup Environment Files
        timeout-minutes: 5
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          # ROOT .env API Keys
          OPENWEATHERMAP_API_KEY: ${{ secrets.OPENWEATHERMAP_API_KEY }}
          OPENAQ_API_KEY: ${{ secrets.OPENAQ_API_KEY }}
          GEONAMES_USERNAME: ${{ secrets.GEONAMES_USERNAME }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          FUSEKI_PASSWORD: ${{ secrets.FUSEKI_PASSWORD }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          # BACKEND .env API Keys
          TICKETMASTER_API_KEY: ${{ secrets.TICKETMASTER_API_KEY }}
          MAPBOX_API_KEY: ${{ secrets.MAPBOX_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          GOOGLE_CALENDAR_API_KEY: ${{ secrets.GOOGLE_CALENDAR_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            set -e
            cd /home/$USER/builder-layer-end
            
            echo "üìÅ Creating directories..."
            mkdir -p logs data data/cache data/rdf reports test_output assets/models
            
            update_env_var() {
              local file=$1 key=$2 value=$3
              [ -n "$value" ] && { grep -q "^$key=" "$file" 2>/dev/null && sed -i "s|^$key=.*|$key=$value|" "$file" || echo "$key=$value" >> "$file"; }
            }
          ENDSSH

          # Setup env files with secrets (separate SSH to pass vars)
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} "
            cd /home/\$USER/builder-layer-end
            
            # Setup ROOT .env
            [ ! -f .env ] && { [ -f .env.example ] && cp .env.example .env || touch .env; }
            
            update_env() { local f=\$1 k=\$2 v=\$3; [ -n \"\$v\" ] && { grep -q \"^\$k=\" \"\$f\" 2>/dev/null && sed -i \"s|^\$k=.*|\$k=\$v|\" \"\$f\" || echo \"\$k=\$v\" >> \"\$f\"; }; }
            
            update_env .env OPENWEATHERMAP_API_KEY '$OPENWEATHERMAP_API_KEY'
            update_env .env OPENAQ_API_KEY '$OPENAQ_API_KEY'
            update_env .env GEONAMES_USERNAME '$GEONAMES_USERNAME'
            update_env .env NEO4J_PASSWORD '$NEO4J_PASSWORD'
            update_env .env FUSEKI_PASSWORD '$FUSEKI_PASSWORD'
            update_env .env POSTGRES_PASSWORD '$POSTGRES_PASSWORD'
            update_env .env MONGODB_PASSWORD '$MONGODB_PASSWORD'
            update_env .env REDIS_PASSWORD '$REDIS_PASSWORD'
            update_env .env SECRET_KEY '$SECRET_KEY'
            
            # Setup BACKEND .env
            BE=apps/traffic-web-app/backend/.env
            [ ! -f \$BE ] && { [ -f apps/traffic-web-app/backend/.env.example ] && cp apps/traffic-web-app/backend/.env.example \$BE || touch \$BE; }
            
            update_env \$BE NEO4J_PASSWORD '$NEO4J_PASSWORD'
            update_env \$BE FUSEKI_PASSWORD '$FUSEKI_PASSWORD'
            update_env \$BE POSTGRES_PASSWORD '$POSTGRES_PASSWORD'
            update_env \$BE TICKETMASTER_API_KEY '$TICKETMASTER_API_KEY'
            update_env \$BE MAPBOX_API_KEY '$MAPBOX_API_KEY'
            update_env \$BE GEMINI_API_KEY '$GEMINI_API_KEY'
            update_env \$BE TAVILY_API_KEY '$TAVILY_API_KEY'
            update_env \$BE OPENWEATHER_API_KEY '$OPENWEATHER_API_KEY'
            update_env \$BE GOOGLE_CALENDAR_API_KEY '$GOOGLE_CALENDAR_API_KEY'
            update_env \$BE GOOGLE_SEARCH_ENGINE_ID '$GOOGLE_SEARCH_ENGINE_ID'
            update_env \$BE GOOGLE_SEARCH_API_KEY '$GOOGLE_SEARCH_API_KEY'
            
            # Setup FRONTEND .env
            [ ! -f apps/traffic-web-app/frontend/.env ] && [ -f apps/traffic-web-app/frontend/.env.example ] && cp apps/traffic-web-app/frontend/.env.example apps/traffic-web-app/frontend/.env || true
            
            echo '‚úÖ Environment files configured'
          "

      # B∆∞·ªõc 5: Setup Python Environment
      - name: üêç Setup Python Environment
        timeout-minutes: 10
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            set -e
            cd /home/$USER/builder-layer-end
            
            echo "üêç Setting up Python environment..."
            [ ! -d ".venv" ] && python3 -m venv .venv
            source .venv/bin/activate
            pip install --upgrade pip setuptools wheel -q
            pip install -r requirements/base.txt -q 2>/dev/null || pip install -r requirements.txt -q 2>/dev/null || true
            pip show yolox > /dev/null 2>&1 || pip install git+https://github.com/Megvii-BaseDetection/YOLOX.git -q 2>/dev/null || echo "YOLOX install skipped"
            
            echo "‚úÖ Python environment ready"
          ENDSSH

      # B∆∞·ªõc 6: Setup Node.js Dependencies
      - name: üì¶ Setup Node.js Dependencies
        timeout-minutes: 10
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            set -e
            cd /home/$USER/builder-layer-end
            
            echo "üì¶ Setting up Node.js dependencies..."
            
            if [ -d "apps/traffic-web-app/backend" ]; then
              cd apps/traffic-web-app/backend
              npm install --prefer-offline --no-audit 2>/dev/null || npm install || true
              cd /home/$USER/builder-layer-end
            fi
            
            if [ -d "apps/traffic-web-app/frontend" ]; then
              cd apps/traffic-web-app/frontend
              npm install --prefer-offline --no-audit 2>/dev/null || npm install || true
              cd /home/$USER/builder-layer-end
            fi
            
            echo "‚úÖ Node.js dependencies ready"
          ENDSSH

      # B∆∞·ªõc 7: Start Docker Services
      - name: üê≥ Start Docker Services
        timeout-minutes: 5
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            echo "üõë Stopping existing services..."
            pkill -f "main.py" 2>/dev/null || true
            pkill -f "orchestrator.py" 2>/dev/null || true
            pkill -f "run_cv_and_sync.py" 2>/dev/null || true
            pkill -f "npm run dev" 2>/dev/null || true
            pkill -f "vite" 2>/dev/null || true
            pm2 stop all 2>/dev/null || true
            sleep 2
            
            echo "üê≥ Starting Docker infrastructure..."
            if docker compose version > /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
            $COMPOSE_CMD up -d neo4j fuseki redis mongodb postgres kafka 2>&1 || true
            
            echo "‚úÖ Docker services started"
          ENDSSH

      # B∆∞·ªõc 8: Wait for Databases
      - name: ‚è≥ Wait for Databases
        run: |
          echo "Waiting for databases to initialize (45s)..."
          sleep 45

      # B∆∞·ªõc 9: Start Stellio Services
      - name: üåê Start Stellio Services
        timeout-minutes: 3
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            if docker compose version > /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
            $COMPOSE_CMD up -d stellio-api-gateway search-service subscription-service 2>&1 || true
            
            echo "‚úÖ Stellio services started"
          ENDSSH

      # B∆∞·ªõc 10: Wait for Stellio
      - name: ‚è≥ Wait for Stellio
        run: |
          echo "Waiting for Stellio to initialize (20s)..."
          sleep 20

      # B∆∞·ªõc 11: Start Application Services
      - name: üöÄ Start Application Services
        timeout-minutes: 5
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            source .venv/bin/activate
            
            echo "üöÄ Starting application services..."
            
            # Run orchestrator briefly (background)
            nohup timeout 120 python3 orchestrator.py > logs/orchestrator.log 2>&1 &
            
            # Python backend
            nohup python3 main.py --run-orchestrator-now > logs/main_py.log 2>&1 &
            echo $! > logs/main_py.pid
            echo "‚úÖ Python backend started"
            
            # CV Analysis Pipeline
            nohup python3 scripts/pipeline/run_cv_and_sync.py --runs 9999 --delay 60 > logs/cv_sync.log 2>&1 &
            echo $! > logs/cv_sync.pid
            echo "‚úÖ CV Analysis Pipeline started"
            
            # TypeScript Backend
            cd apps/traffic-web-app/backend
            nohup npm run dev > ../../../logs/ts_backend.log 2>&1 &
            echo $! > ../../../logs/ts_backend.pid
            cd /home/$USER/builder-layer-end
            echo "‚úÖ TypeScript backend started"
            
            # React Frontend
            cd apps/traffic-web-app/frontend
            nohup npm run dev -- --host 0.0.0.0 > ../../../logs/frontend.log 2>&1 &
            echo $! > ../../../logs/frontend.pid
            cd /home/$USER/builder-layer-end
            echo "‚úÖ React frontend started"
            
            echo ""
            echo "============================================"
            echo "  ‚úÖ ALL SERVICES STARTED!"
            echo "============================================"
          ENDSSH

      # B∆∞·ªõc 12: Health check
      - name: üè• Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          echo "üè• Running health check..."
          sleep 15

          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            echo "Checking services..."
            
            # Check Docker containers
            if docker ps --format '{{.Names}}' | grep -q "test-"; then
              echo "‚úÖ Docker containers are running"
            else
              echo "‚ö†Ô∏è Some Docker containers may not be running"
            fi
            
            # Check Python processes
            if pgrep -f "main.py" > /dev/null; then
              echo "‚úÖ Main Python service is running"
            else
              echo "‚ö†Ô∏è Main Python service is not running"
            fi
            
            # Check CV Analysis
            if pgrep -f "run_cv_and_sync.py" > /dev/null; then
              echo "‚úÖ CV Analysis pipeline is running"
            else
              echo "‚ö†Ô∏è CV Analysis pipeline is not running"
            fi
            
            # Show running processes
            echo ""
            echo "üìã Running processes:"
            ps aux | grep -E "main.py|run_cv_and_sync|node" | grep -v grep || echo "No processes found"
            
            echo ""
            echo "============================================"
            echo "  ‚úÖ VPS DEPLOYMENT COMPLETED!"
            echo "============================================"
            echo "üåê Main URL:  http://${{ secrets.VPS_HOST }}"
            echo "  - Frontend:   http://${{ secrets.VPS_HOST }}:5173"
            echo "  - Backend:    http://${{ secrets.VPS_HOST }}:5000"
            echo "  - FastAPI:    http://${{ secrets.VPS_HOST }}:8001"
            echo "  - Stellio:    http://${{ secrets.VPS_HOST }}:8080"
            echo "  - Neo4j:      http://${{ secrets.VPS_HOST }}:7474"
            echo "============================================"
          ENDSSH
