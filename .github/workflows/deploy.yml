# ============================================================================
# UIP - Urban Intelligence Platform
# Copyright (c) 2024-2025 UIP Team. All rights reserved.
# https://github.com/UIP-Urban-Intelligence-Platform/UIP-Urban_Intelligence_Platform
#
# SPDX-License-Identifier: MIT
# ============================================================================
# File: .github/workflows/deploy.yml
# Module: CI/CD Pipeline - Auto Deploy to Ubuntu VPS
# Author: Nguyen Dinh Anh Tuan
# Created: 2025-12-08
# Version: 1.0.0
# License: MIT
#
# Description:
#   Automated CI/CD pipeline for deploying to Ubuntu VPS
#   - Ch·ª©c nƒÉng 1: T·ª± ƒë·ªông ƒë·∫©y code l√™n server khi c√≥ thay ƒë·ªïi tr√™n GitHub
#   - Ch·ª©c nƒÉng 2: T·ª± ƒë·ªông kh·ªüi ch·∫°y l·∫°i project sau khi deploy
#
# Server Info:
#   - IP:
#   - User:
#   - Path: /home/deepminds/builder-layer-end
#
# Prerequisites:
#   1. T·∫°o c√°c secrets trong GitHub Repository Settings > Secrets:
#      - VPS_HOST:
#      - VPS_USER:
#      - VPS_SSH_KEY: Private SSH key ƒë·ªÉ k·∫øt n·ªëi VPS
#      - VPS_PORT: 22
#      - VPS_PASSWORD: Password SSH (n·∫øu d√πng password thay v√¨ key)
#
#   2. Tr√™n VPS Ubuntu ƒë√£ c√≥ s·∫µn:
#      - Python 3.x
#      - Node.js
#      - Docker & Docker Compose
#
# Usage:
#   - Push code l√™n branch main s·∫Ω t·ª± ƒë·ªông trigger deploy
#   - C√≥ th·ªÉ ch·∫°y th·ªß c√¥ng t·ª´ Actions tab
# ============================================================================

name: Deploy to Ubuntu VPS

on:
    # Trigger khi push l√™n branch main (nh√°nh ch√≠nh ƒë·ªÉ deploy)
    # Nh√°nh Quang l√† nh√°nh ph√°t tri·ªÉn, merge v√†o main khi mu·ªën deploy
    push:
        branches:
            - main

    # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ GitHub Actions tab
    workflow_dispatch:
        inputs:
            skip_orchestrator:
                description: "Skip running orchestrator and CV sync"
                required: false
                default: "false"
                type: boolean
            full_restart:
                description: "Full restart (stop all services first)"
                required: false
                default: "false"
                type: boolean

env:
    PROJECT_NAME: uip-urban-intelligence-platform

jobs:
    # ===========================================================================
    # Job 1: Deploy code to VPS
    # ===========================================================================
    deploy:
        name: üöÄ Deploy to VPS
        runs-on: ubuntu-latest

        steps:
            # B∆∞·ªõc 1: Checkout code
            - name: üì• Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch full history for proper sync

            # B∆∞·ªõc 2: Install sshpass (ƒë·ªÉ d√πng password SSH)
            - name: üîß Install sshpass
              run: sudo apt-get install -y sshpass

            # B∆∞·ªõc 3: Deploy code l√™n VPS b·∫±ng rsync
            - name: üì§ Deploy code to VPS
              env:
                  VPS_HOST: ${{ secrets.VPS_HOST }}
                  VPS_USER: ${{ secrets.VPS_USER }}
                  VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
                  VPS_PORT: ${{ secrets.VPS_PORT }}
              run: |
                  echo "üöÄ Deploying to VPS: $VPS_HOST"

                  # Disable strict host key checking
                  mkdir -p ~/.ssh
                  echo "StrictHostKeyChecking no" >> ~/.ssh/config

                  # Sync code using rsync v·ªõi sshpass (password authentication)
                  sshpass -p "$VPS_PASSWORD" rsync -avz --delete \
                    --exclude '.git' \
                    --exclude '.venv' \
                    --exclude 'node_modules' \
                    --exclude '__pycache__' \
                    --exclude '*.pyc' \
                    --exclude '.env' \
                    --exclude 'logs/*' \
                    --exclude 'data/cache/*' \
                    --exclude 'test_output/*' \
                    --exclude 'htmlcov' \
                    --exclude 'coverage.xml' \
                    --exclude '.pytest_cache' \
                    --exclude 'assets/models/*.pth' \
                    -e "ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no" \
                    ./ ${VPS_USER}@${VPS_HOST}:/home/${VPS_USER}/builder-layer-end/

                  echo "‚úÖ Code deployed successfully!"

            # B∆∞·ªõc 4: C√†i ƒë·∫∑t dependencies v√† kh·ªüi ch·∫°y project
            - name: üîß Setup and Start Project
              env:
                  VPS_HOST: ${{ secrets.VPS_HOST }}
                  VPS_USER: ${{ secrets.VPS_USER }}
                  VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
                  VPS_PORT: ${{ secrets.VPS_PORT }}
              run: |
                  sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
                    set -e
                    
                    echo "üìÅ Navigating to project directory..."
                    cd /home/$USER/builder-layer-end
                    
                    echo "============================================"
                    echo "  UIP - Urban Intelligence Platform"
                    echo "  Auto Deployment from GitHub Actions"
                    echo "============================================"
                    
                    # ==== Step 1: Create directories ====
                    echo "üìÅ Creating directories..."
                    mkdir -p logs data data/cache data/rdf reports test_output assets/models
                    
                    # ==== Step 2: Setup environment files ====
                    echo "üìÑ Setting up environment files..."
                    [ ! -f ".env" ] && [ -f ".env.example" ] && cp .env.example .env || true
                    [ ! -f "apps/traffic-web-app/backend/.env" ] && [ -f "apps/traffic-web-app/backend/.env.example" ] && cp apps/traffic-web-app/backend/.env.example apps/traffic-web-app/backend/.env || true
                    [ ! -f "apps/traffic-web-app/frontend/.env" ] && [ -f "apps/traffic-web-app/frontend/.env.example" ] && cp apps/traffic-web-app/frontend/.env.example apps/traffic-web-app/frontend/.env || true
                    
                    # ==== Step 3: Setup Python environment ====
                    echo "üêç Setting up Python environment..."
                    [ ! -d ".venv" ] && python3 -m venv .venv
                    source .venv/bin/activate
                    pip install --upgrade pip setuptools wheel -q
                    pip install -r requirements/base.txt -q 2>/dev/null || pip install -r requirements.txt -q 2>/dev/null || true
                    pip show yolox > /dev/null 2>&1 || pip install git+https://github.com/Megvii-BaseDetection/YOLOX.git -q 2>/dev/null || echo "YOLOX install skipped"
                    
                    # ==== Step 4: Setup Node.js dependencies ====
                    echo "üì¶ Setting up Node.js dependencies..."
                    [ -d "apps/traffic-web-app/backend" ] && (cd apps/traffic-web-app/backend && npm install --silent 2>/dev/null || npm install)
                    [ -d "apps/traffic-web-app/frontend" ] && (cd apps/traffic-web-app/frontend && npm install --silent 2>/dev/null || npm install)
                    
                    # ==== Step 5: Stop existing services ====
                    echo "üõë Stopping existing services..."
                    pkill -f "main.py" 2>/dev/null || true
                    pkill -f "orchestrator.py" 2>/dev/null || true
                    pkill -f "run_cv_and_sync.py" 2>/dev/null || true
                    pkill -f "npm run dev" 2>/dev/null || true
                    pkill -f "vite" 2>/dev/null || true
                    pm2 stop all 2>/dev/null || true
                    sleep 3
                    
                    # ==== Step 6: Start Docker services ====
                    echo "üê≥ Starting Docker infrastructure..."
                    if docker compose version > /dev/null 2>&1; then
                      COMPOSE_CMD="docker compose"
                    else
                      COMPOSE_CMD="docker-compose"
                    fi
                    $COMPOSE_CMD up -d neo4j fuseki redis mongodb postgres kafka 2>&1 || true
                    echo "Waiting for databases (60s)..."
                    sleep 60
                    $COMPOSE_CMD up -d stellio-api-gateway search-service subscription-service 2>&1 || true
                    echo "Waiting for Stellio (30s)..."
                    sleep 30
                    
                    # ==== Step 7: Run initial scripts (QUAN TR·ªåNG!) ====
                    echo "üöÄ Running initial scripts..."
                    source .venv/bin/activate
                    
                    echo "Step 7a: Running orchestrator.py..."
                    timeout 300 python3 orchestrator.py &
                    sleep 15
                    
                    echo "Step 7b: Running run_cv_and_sync.py (initial sync)..."
                    timeout 600 python3 scripts/pipeline/run_cv_and_sync.py --runs 1 --delay 0 2>/dev/null || true
                    
                    # ==== Step 8: Start main services (continuous mode) ====
                    echo "üéØ Starting main services..."
                    
                    # Python backend
                    nohup python3 main.py --run-orchestrator-now > logs/main_py.log 2>&1 &
                    echo $! > logs/main_py.pid
                    echo "‚úÖ Python backend started"
                    
                    # CV Analysis Pipeline (continuous)
                    nohup python3 scripts/pipeline/run_cv_and_sync.py --runs 9999 --delay 60 > logs/cv_sync.log 2>&1 &
                    echo $! > logs/cv_sync.pid
                    echo "‚úÖ CV Analysis Pipeline started"
                    
                    # TypeScript Backend
                    cd apps/traffic-web-app/backend
                    nohup npm run dev > ../../../logs/ts_backend.log 2>&1 &
                    echo $! > ../../../logs/ts_backend.pid
                    cd /home/$USER/builder-layer-end
                    echo "‚úÖ TypeScript backend started"
                    
                    # React Frontend
                    cd apps/traffic-web-app/frontend
                    nohup npm run dev -- --host 0.0.0.0 > ../../../logs/frontend.log 2>&1 &
                    echo $! > ../../../logs/frontend.pid
                    cd /home/$USER/builder-layer-end
                    echo "‚úÖ React frontend started"
                    
                    echo ""
                    echo "============================================"
                    echo "  ‚úÖ DEPLOYMENT COMPLETED!"
                    echo "============================================"
                    echo "Services running:"
                    echo "  üåê Main URL:  http://54.179.155.70 (via Nginx)"
                    echo "  - Frontend:   http://54.179.155.70:5173"
                    echo "  - Backend:    http://54.179.155.70:5000"
                    echo "  - FastAPI:    http://54.179.155.70:8001"
                    echo "  - Stellio:    http://54.179.155.70:8080"
                    echo "  - Neo4j:      http://54.179.155.70:7474"
                    echo "============================================"
                  ENDSSH

            # B∆∞·ªõc 5: Health check
            - name: üè• Health Check
              env:
                  VPS_HOST: ${{ secrets.VPS_HOST }}
                  VPS_USER: ${{ secrets.VPS_USER }}
                  VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
                  VPS_PORT: ${{ secrets.VPS_PORT }}
              run: |
                  echo "üè• Running health check..."
                  sleep 30

                  sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
                    cd /home/$USER/builder-layer-end
                    
                    echo "Checking services..."
                    
                    # Check Docker containers
                    if docker ps --format '{{.Names}}' | grep -q "test-"; then
                      echo "‚úÖ Docker containers are running"
                    else
                      echo "‚ö†Ô∏è Some Docker containers may not be running"
                    fi
                    
                    # Check Python processes
                    if pgrep -f "main.py" > /dev/null; then
                      echo "‚úÖ Main Python service is running"
                    else
                      echo "‚ö†Ô∏è Main Python service is not running"
                    fi
                    
                    # Check CV Analysis
                    if pgrep -f "run_cv_and_sync.py" > /dev/null; then
                      echo "‚úÖ CV Analysis pipeline is running"
                    else
                      echo "‚ö†Ô∏è CV Analysis pipeline is not running"
                    fi
                    
                    # Show running processes
                    echo ""
                    echo "üìã Running processes:"
                    ps aux | grep -E "main.py|run_cv_and_sync|node" | grep -v grep || echo "No processes found"
                  ENDSSH

    # ===========================================================================
    # Job 2: Deploy Docusaurus Docs to GitHub Pages
    # ===========================================================================
    deploy-docs:
        name: üìö Deploy Docs to GitHub Pages
        runs-on: ubuntu-latest
        needs: deploy

        # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
        permissions:
            pages: write
            id-token: write
            contents: read

        # Deploy to the github-pages environment
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            # B∆∞·ªõc 1: Checkout code
            - name: üì• Checkout code
              uses: actions/checkout@v4

            # B∆∞·ªõc 2: Setup Node.js
            - name: üì¶ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: apps/traffic-web-app/frontend/docs/package-lock.json

            # B∆∞·ªõc 3: Install dependencies
            - name: üì¶ Install dependencies
              working-directory: apps/traffic-web-app/frontend/docs
              run: npm ci || npm install

            # B∆∞·ªõc 4: Build Docusaurus
            - name: üî® Build Docusaurus
              working-directory: apps/traffic-web-app/frontend/docs
              run: npm run build

            # B∆∞·ªõc 5: Setup Pages
            - name: üìÑ Setup Pages
              uses: actions/configure-pages@v4

            # B∆∞·ªõc 6: Upload artifact
            - name: üì§ Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: apps/traffic-web-app/frontend/docs/build

            # B∆∞·ªõc 7: Deploy to GitHub Pages
            - name: üöÄ Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

    # ===========================================================================
    # Job 3: Notify on completion (optional)
    # ===========================================================================
    notify:
        name: üì¢ Notify
        runs-on: ubuntu-latest
        needs: [deploy, deploy-docs]
        if: always()

        steps:
            - name: üì¢ Send notification
              run: |
                  echo "============================================"
                  echo "  üì¢ Deployment Summary"
                  echo "============================================"
                  
                  if [ "${{ needs.deploy.result }}" == "success" ]; then
                    echo "‚úÖ VPS Deployment: SUCCESS"
                    echo "üåê Project deployed to: ${{ secrets.VPS_HOST }}"
                  else
                    echo "‚ùå VPS Deployment: FAILED"
                  fi
                  
                  if [ "${{ needs.deploy-docs.result }}" == "success" ]; then
                    echo "‚úÖ Docs Deployment: SUCCESS"
                    echo "üìö Docs URL: https://uip-urban-intelligence-platform.github.io/UIP-Urban_Intelligence_Platform/"
                  else
                    echo "‚ö†Ô∏è Docs Deployment: FAILED or SKIPPED"
                  fi
                  
                  echo "============================================"
