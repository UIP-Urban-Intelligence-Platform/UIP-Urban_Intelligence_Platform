# ============================================================================
# UIP - Urban Intelligence Platform
# Copyright (c) 2024-2025 UIP Team. All rights reserved.
# https://github.com/UIP-Urban-Intelligence-Platform/UIP-Urban_Intelligence_Platform
#
# SPDX-License-Identifier: MIT
# ============================================================================
# File: .github/workflows/deploy.yml
# Module: CI/CD Pipeline - Auto Deploy to Ubuntu VPS
# Author: Nguyen Dinh Anh Tuan
# Created: 2025-12-08
# Version: 1.0.0
# License: MIT
#
# Description:
#   Automated CI/CD pipeline for deploying to Ubuntu VPS
#   - Ch·ª©c nƒÉng 1: T·ª± ƒë·ªông ƒë·∫©y code l√™n server khi c√≥ thay ƒë·ªïi tr√™n GitHub
#   - Ch·ª©c nƒÉng 2: T·ª± ƒë·ªông kh·ªüi ch·∫°y l·∫°i project sau khi deploy
#
# Server Info:
#   - IP:
#   - User:
#   - Path: /home/deepminds/builder-layer-end
#
# Prerequisites:
#   1. T·∫°o c√°c secrets trong GitHub Repository Settings > Secrets:
#      - VPS_HOST:
#      - VPS_USER:
#      - VPS_SSH_KEY: Private SSH key ƒë·ªÉ k·∫øt n·ªëi VPS
#      - VPS_PORT: 22
#      - VPS_PASSWORD: Password SSH (n·∫øu d√πng password thay v√¨ key)
#
#   2. Tr√™n VPS Ubuntu ƒë√£ c√≥ s·∫µn:
#      - Python 3.x
#      - Node.js
#      - Docker & Docker Compose
#
# Usage:
#   - Push code l√™n branch main s·∫Ω t·ª± ƒë·ªông trigger deploy
#   - C√≥ th·ªÉ ch·∫°y th·ªß c√¥ng t·ª´ Actions tab
# ============================================================================

name: Deploy to Ubuntu VPS

on:
  # Trigger khi push l√™n branch main ho·∫∑c tuan
  push:
    branches:
      - main

  # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ GitHub Actions tab
  workflow_dispatch:
    inputs:
      skip_orchestrator:
        description: "Skip running orchestrator and CV sync"
        required: false
        default: false
        type: boolean
      full_restart:
        description: "Full restart (stop all services first)"
        required: false
        default: false
        type: boolean

env:
  PROJECT_NAME: uip-urban-intelligence-platform

jobs:
  # ===========================================================================
  # Job 1: Deploy code to VPS
  # ===========================================================================
  deploy:
    name: üöÄ Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      # B∆∞·ªõc 1: Checkout code
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for proper sync

      # B∆∞·ªõc 2: Install sshpass for password authentication
      - name: üîë Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      # B∆∞·ªõc 3: Stop all running services before deploy
      - name: üõë Stop All Running Services
        continue-on-error: true
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          echo "üõë Stopping all running services before deploy..."
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} bash << 'ENDSSH'
            set +e  # Kh√¥ng exit khi c√≥ l·ªói
            
            echo "üõë Stopping PM2 processes..."
            if command -v pm2 &> /dev/null; then
              pm2 stop all 2>/dev/null
              pm2 delete all 2>/dev/null
              echo "  ‚úì PM2 processes stopped"
            else
              echo "  - PM2 not installed, skipping"
            fi
            
            echo "üõë Killing application processes if running..."
            
            # Function to safely kill process
            safe_kill() {
              if pgrep -f "$1" > /dev/null 2>&1; then
                pkill -f "$1" 2>/dev/null
                echo "  ‚úì Killed: $1"
              fi
            }
            
            safe_kill "main.py"
            safe_kill "orchestrator.py"
            safe_kill "run_cv_and_sync.py"
            safe_kill "npm run dev"
            safe_kill "vite"
            safe_kill "uvicorn"
            
            echo "üõë Stopping Nginx if running..."
            if systemctl is-active --quiet nginx 2>/dev/null; then
              echo "$VPS_PASSWORD" | sudo -S systemctl stop nginx 2>/dev/null
              echo "  ‚úì Nginx stopped"
            else
              echo "  - Nginx not running, skipping"
            fi
            
            sleep 2
            echo "‚úÖ All services check completed"
            exit 0
          ENDSSH
          echo "‚úÖ Stop services step completed"

      # B∆∞·ªõc 4: Deploy code l√™n VPS b·∫±ng rsync
      - name: üì§ Deploy code to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          echo "üöÄ Deploying to VPS: $VPS_HOST"

          # Sync code using rsync v·ªõi sshpass (password authentication)
          sshpass -p "$VPS_PASSWORD" rsync -avz --delete \
            --exclude '.git' \
            --exclude '.venv' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'logs/*' \
            --exclude 'data/cache/*' \
            --exclude 'test_output/*' \
            --exclude 'htmlcov' \
            --exclude 'coverage.xml' \
            --exclude '.pytest_cache' \
            --exclude 'assets/models/*.pth' \
            -e "ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ./ ${VPS_USER}@${VPS_HOST}:/home/${VPS_USER}/builder-layer-end/

          echo "‚úÖ Code deployed successfully!"

      # B∆∞·ªõc 5: Setup Environment Files
      - name: üìÑ Setup Environment Files
        timeout-minutes: 5
        continue-on-error: true
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          # ROOT .env API Keys
          OPENWEATHERMAP_API_KEY: ${{ secrets.OPENWEATHERMAP_API_KEY }}
          OPENAQ_API_KEY: ${{ secrets.OPENAQ_API_KEY }}
          GEONAMES_USERNAME: ${{ secrets.GEONAMES_USERNAME }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          FUSEKI_PASSWORD: ${{ secrets.FUSEKI_PASSWORD }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          # BACKEND .env API Keys
          TICKETMASTER_API_KEY: ${{ secrets.TICKETMASTER_API_KEY }}
          MAPBOX_API_KEY: ${{ secrets.MAPBOX_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          GOOGLE_CALENDAR_API_KEY: ${{ secrets.GOOGLE_CALENDAR_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end || exit 1
            
            echo "üìÅ Creating directories..."
            mkdir -p logs data data/cache data/rdf reports test_output assets/models
            
            echo "‚úÖ Directories created"
          ENDSSH

          # Setup env files with secrets (separate SSH to pass vars)
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} "
            cd /home/\$USER/builder-layer-end
            
            # Setup ROOT .env
            [ ! -f .env ] && { [ -f .env.example ] && cp .env.example .env || touch .env; }
            
            update_env() { local f=\$1 k=\$2 v=\$3; [ -n \"\$v\" ] && { grep -q \"^\$k=\" \"\$f\" 2>/dev/null && sed -i \"s|^\$k=.*|\$k=\$v|\" \"\$f\" || echo \"\$k=\$v\" >> \"\$f\"; }; }
            
            update_env .env OPENWEATHERMAP_API_KEY '$OPENWEATHERMAP_API_KEY'
            update_env .env OPENAQ_API_KEY '$OPENAQ_API_KEY'
            update_env .env GEONAMES_USERNAME '$GEONAMES_USERNAME'
            update_env .env NEO4J_PASSWORD '$NEO4J_PASSWORD'
            update_env .env FUSEKI_PASSWORD '$FUSEKI_PASSWORD'
            update_env .env POSTGRES_PASSWORD '$POSTGRES_PASSWORD'
            update_env .env MONGODB_PASSWORD '$MONGODB_PASSWORD'
            update_env .env REDIS_PASSWORD '$REDIS_PASSWORD'
            update_env .env SECRET_KEY '$SECRET_KEY'
            
            # Setup BACKEND .env
            BE=apps/traffic-web-app/backend/.env
            [ ! -f \$BE ] && { [ -f apps/traffic-web-app/backend/.env.example ] && cp apps/traffic-web-app/backend/.env.example \$BE || touch \$BE; }
            
            update_env \$BE NEO4J_PASSWORD '$NEO4J_PASSWORD'
            update_env \$BE FUSEKI_PASSWORD '$FUSEKI_PASSWORD'
            update_env \$BE POSTGRES_PASSWORD '$POSTGRES_PASSWORD'
            update_env \$BE TICKETMASTER_API_KEY '$TICKETMASTER_API_KEY'
            update_env \$BE MAPBOX_API_KEY '$MAPBOX_API_KEY'
            update_env \$BE GEMINI_API_KEY '$GEMINI_API_KEY'
            update_env \$BE TAVILY_API_KEY '$TAVILY_API_KEY'
            update_env \$BE OPENWEATHER_API_KEY '$OPENWEATHER_API_KEY'
            update_env \$BE GOOGLE_CALENDAR_API_KEY '$GOOGLE_CALENDAR_API_KEY'
            update_env \$BE GOOGLE_SEARCH_ENGINE_ID '$GOOGLE_SEARCH_ENGINE_ID'
            update_env \$BE GOOGLE_SEARCH_API_KEY '$GOOGLE_SEARCH_API_KEY'
            
            # Setup FRONTEND .env
            [ ! -f apps/traffic-web-app/frontend/.env ] && [ -f apps/traffic-web-app/frontend/.env.example ] && cp apps/traffic-web-app/frontend/.env.example apps/traffic-web-app/frontend/.env || true
            
            echo '‚úÖ Environment files configured'
          "

      # B∆∞·ªõc 5: Setup Python Environment
      - name: üêç Setup Python Environment
        timeout-minutes: 10
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=10 ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            echo "üêç Setting up Python environment..."
            [ ! -d ".venv" ] && python3 -m venv .venv
            source .venv/bin/activate
            pip install --upgrade pip setuptools wheel -q
            pip install -r requirements/base.txt -q 2>/dev/null || pip install -r requirements.txt -q 2>/dev/null || true
            
            # Install statsmodels for analytics agents
            pip install statsmodels scipy -q 2>/dev/null || true
            
            # Install timm (required for DETR accident detection)
            pip install timm -q 2>/dev/null || true
            
            # Install YOLOX from GitHub (Apache-2.0 license)
            pip show yolox > /dev/null 2>&1 || pip install git+https://github.com/Megvii-BaseDetection/YOLOX.git -q 2>/dev/null || echo "YOLOX install skipped"
            
            echo "‚úÖ Python environment ready"
          ENDSSH

      # B∆∞·ªõc 6: Download ML Models (YOLOX weights + DETR)
      - name: ü§ñ Download ML Models
        timeout-minutes: 15
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=10 ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            source .venv/bin/activate
            
            echo "ü§ñ Downloading ML models..."
            
            # Create models directory
            mkdir -p assets/models
            
            # Download YOLOX-X weights (794MB) if not exists
            if [ ! -f "assets/models/yolox_x.pth" ]; then
              echo "üì• Downloading YOLOX-X weights (794MB)..."
              if [ -f "scripts/download_yolox_weights.py" ]; then
                python scripts/download_yolox_weights.py --model yolox-x 2>/dev/null || {
                  echo "‚ö†Ô∏è Script failed, trying direct download..."
                  curl -L -o assets/models/yolox_x.pth "https://github.com/Megvii-BaseDetection/YOLOX/releases/download/0.1.1rc0/yolox_x.pth" 2>/dev/null || true
                }
              else
                echo "üì• Direct download YOLOX-X weights..."
                curl -L -o assets/models/yolox_x.pth "https://github.com/Megvii-BaseDetection/YOLOX/releases/download/0.1.1rc0/yolox_x.pth" 2>/dev/null || true
              fi
              
              if [ -f "assets/models/yolox_x.pth" ]; then
                SIZE=$(du -h assets/models/yolox_x.pth | cut -f1)
                echo "‚úÖ YOLOX-X weights downloaded ($SIZE)"
              else
                echo "‚ö†Ô∏è YOLOX weights download failed - CV will use mock detector"
              fi
            else
              SIZE=$(du -h assets/models/yolox_x.pth | cut -f1)
              echo "‚úÖ YOLOX-X weights already exist ($SIZE)"
            fi
            
            # Download DETR accident detection model
            echo "üì• Downloading DETR accident detection model..."
            if [ -f "scripts/download_accident_model.py" ]; then
              python scripts/download_accident_model.py 2>/dev/null || echo "‚ö†Ô∏è DETR model download skipped"
            else
              # Pre-download using transformers
              python -c "from transformers import DetrForObjectDetection, DetrImageProcessor; DetrForObjectDetection.from_pretrained('hilmantm/detr-traffic-accident-detection'); DetrImageProcessor.from_pretrained('hilmantm/detr-traffic-accident-detection'); print('‚úÖ DETR model downloaded')" 2>/dev/null || echo "‚ö†Ô∏è DETR model download skipped"
            fi
            
            echo "‚úÖ ML models setup complete"
          ENDSSH

      # B∆∞·ªõc 7: Setup Node.js Dependencies
      - name: üì¶ Setup Node.js Dependencies
        timeout-minutes: 10
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=10 ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            echo "üì¶ Setting up Node.js dependencies..."
            
            # Install PM2 globally if not exists
            which pm2 > /dev/null 2>&1 || npm install -g pm2
            
            if [ -d "apps/traffic-web-app/backend" ]; then
              cd apps/traffic-web-app/backend
              npm install --prefer-offline --no-audit 2>/dev/null || npm install || true
              cd /home/$USER/builder-layer-end
            fi
            
            if [ -d "apps/traffic-web-app/frontend" ]; then
              cd apps/traffic-web-app/frontend
              npm install --prefer-offline --no-audit 2>/dev/null || npm install || true
              cd /home/$USER/builder-layer-end
            fi
            
            echo "‚úÖ Node.js dependencies ready"
          ENDSSH

      # B∆∞·ªõc 8: Start Docker Services
      - name: üê≥ Start Docker Services
        timeout-minutes: 5
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            echo "üê≥ Starting Docker infrastructure..."
            if docker compose version > /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
            $COMPOSE_CMD up -d neo4j fuseki redis mongodb postgres kafka 2>&1 || true
            
            echo "‚úÖ Docker services started"
          ENDSSH

      # B∆∞·ªõc 9: Wait for Databases
      - name: ‚è≥ Wait for Databases
        run: |
          echo "Waiting for databases to initialize (45s)..."
          sleep 45

      # B∆∞·ªõc 10: Start Stellio Services
      - name: üåê Start Stellio Services
        timeout-minutes: 3
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            if docker compose version > /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
            $COMPOSE_CMD up -d stellio-api-gateway search-service subscription-service 2>&1 || true
            
            echo "‚úÖ Stellio services started"
          ENDSSH

      # B∆∞·ªõc 11: Wait for Stellio
      - name: ‚è≥ Wait for Stellio
        run: |
          echo "Waiting for Stellio to initialize (20s)..."
          sleep 20

      # B∆∞·ªõc 12: Setup Nginx Reverse Proxy
      - name: üåê Setup Nginx Reverse Proxy
        timeout-minutes: 3
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          # Create nginx config locally first
          cat > /tmp/nginx_uip.conf << 'NGINXCONF'
          server {
              listen 80;
              server_name _;
              
              location / {
                  proxy_pass http://127.0.0.1:5173;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
                  proxy_read_timeout 86400;
              }
              
              location /api/ {
                  proxy_pass http://127.0.0.1:5000/;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 300;
                  proxy_connect_timeout 300;
              }
              
              location /fastapi/ {
                  proxy_pass http://127.0.0.1:8001/;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 300;
                  proxy_connect_timeout 300;
              }
              
              location /ngsi-ld/ {
                  proxy_pass http://127.0.0.1:8080/ngsi-ld/;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location /neo4j/ {
                  proxy_pass http://127.0.0.1:7474/;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          NGINXCONF

          # Upload nginx config to VPS
          sshpass -p "$VPS_PASSWORD" scp -P ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /tmp/nginx_uip.conf ${VPS_USER}@${VPS_HOST}:/tmp/nginx_uip.conf

          # Setup nginx on VPS
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} "
            echo 'üåê Setting up Nginx reverse proxy...'
            
            # Install Nginx if not exists
            if ! command -v nginx &> /dev/null; then
              echo '$VPS_PASSWORD' | sudo -S apt-get update
              echo '$VPS_PASSWORD' | sudo -S apt-get install -y nginx
            fi
            
            # Copy config to nginx sites
            echo '$VPS_PASSWORD' | sudo -S cp /tmp/nginx_uip.conf /etc/nginx/sites-available/uip
            echo '$VPS_PASSWORD' | sudo -S ln -sf /etc/nginx/sites-available/uip /etc/nginx/sites-enabled/
            echo '$VPS_PASSWORD' | sudo -S rm -f /etc/nginx/sites-enabled/default
            
            # Test and reload Nginx
            echo '$VPS_PASSWORD' | sudo -S nginx -t
            echo '$VPS_PASSWORD' | sudo -S systemctl reload nginx || echo '$VPS_PASSWORD' | sudo -S systemctl start nginx
            echo '$VPS_PASSWORD' | sudo -S systemctl enable nginx
            
            echo '‚úÖ Nginx reverse proxy configured'
          "

      # B∆∞·ªõc 13: Setup PM2 Ecosystem
      - name: üìã Setup PM2 Ecosystem
        timeout-minutes: 2
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          # Create ecosystem config with orchestrator using cron_restart (runs every hour at minute 0)
          ECOSYSTEM='module.exports={apps:[{name:"orchestrator",script:"orchestrator.py",interpreter:".venv/bin/python3",cwd:"/home/deepminds/builder-layer-end",cron_restart:"0 * * * *",autorestart:false,watch:false,env:{PYTHONUNBUFFERED:"1"}},{name:"main-api",script:"main.py",interpreter:".venv/bin/python3",cwd:"/home/deepminds/builder-layer-end",autorestart:true,max_restarts:10,watch:false,env:{PYTHONUNBUFFERED:"1"}},{name:"cv-analysis",script:"scripts/pipeline/run_cv_and_sync.py",args:"--runs 9999 --delay 60",interpreter:".venv/bin/python3",cwd:"/home/deepminds/builder-layer-end",autorestart:true,max_restarts:10,watch:false,env:{PYTHONUNBUFFERED:"1"}},{name:"ts-backend",script:"npm",args:"run dev",cwd:"/home/deepminds/builder-layer-end/apps/traffic-web-app/backend",autorestart:true,max_restarts:10,watch:false},{name:"react-frontend",script:"npm",args:"run dev -- --host 0.0.0.0",cwd:"/home/deepminds/builder-layer-end/apps/traffic-web-app/frontend",autorestart:true,max_restarts:10,watch:false}]};'

          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} "
            cd /home/\$USER/builder-layer-end
            which pm2 > /dev/null 2>&1 || npm install -g pm2
            echo '$ECOSYSTEM' > ecosystem.config.js
            echo '‚úÖ PM2 ecosystem config created - orchestrator runs every hour (cron: 0 * * * *)'
          "

      # B∆∞·ªõc 14: Start Application Services with PM2
      - name: üöÄ Start Application Services with PM2
        timeout-minutes: 3
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            cd /home/$USER/builder-layer-end
            
            echo "üöÄ Starting all services with PM2..."
            
            # Start all apps using PM2 ecosystem
            pm2 start ecosystem.config.js
            
            # Save PM2 process list (auto-restart on reboot)
            pm2 save
            
            # Setup PM2 startup script (runs PM2 on system boot)
            pm2 startup systemd -u $USER --hp /home/$USER 2>/dev/null || true
            
            echo ""
            echo "‚úÖ All services started with PM2!"
            echo ""
            pm2 list
          ENDSSH

      # B∆∞·ªõc 15: Health check
      - name: üè• Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          echo "üè• Running health check..."
          sleep 15

          sshpass -p "$VPS_PASSWORD" ssh -p ${VPS_PORT:-22} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -T ${VPS_USER}@${VPS_HOST} << ENDSSH
            cd /home/\$USER/builder-layer-end
            
            echo "üìä PM2 Status:"
            pm2 list
            
            echo ""
            echo "Checking services..."
            
            # Check Docker containers
            if docker ps --format '{{.Names}}' | grep -q "test-"; then
              echo "‚úÖ Docker containers are running"
            else
              echo "‚ö†Ô∏è Some Docker containers may not be running"
            fi
            
            # Check PM2 processes status
            echo ""
            echo "üìã PM2 Process Status:"
            pm2 list --no-color 2>/dev/null | grep -E "online|stopped|errored" || echo "PM2 processes checked"
            
            echo ""
            echo "============================================"
            echo "  ‚úÖ VPS DEPLOYMENT COMPLETED!"
            echo "============================================"
            echo "üåê Service URLs:"
            echo "  - Main Site:  http://$VPS_HOST/"
            echo "  - Frontend:   http://$VPS_HOST:5173"
            echo "  - Backend:    http://$VPS_HOST:5000"
            echo "  - FastAPI:    http://$VPS_HOST:8001"
            echo "  - Stellio:    http://$VPS_HOST:8080"
            echo "  - Neo4j:      http://$VPS_HOST:7474"
            echo "============================================"
            echo ""
            echo "üìù PM2 Commands:"
            echo "  pm2 logs          - View all logs"
            echo "  pm2 logs <name>   - View specific app logs"
            echo "  pm2 restart all   - Restart all apps"
            echo "  pm2 monit         - Monitor dashboard"
            echo "============================================"
          ENDSSH
